<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ToxEcology Product Scanner</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <!-- ZXing Barcode Scanner Library - works on all browsers -->
  <script src="https://unpkg.com/@zxing/library@0.19.1/umd/index.min.js"></script>
  <style>
    :root {
      --midnight: #0A1628;
      --deep-teal: #142238;
      --cyan: #00D9FF;
      --cyan-dim: rgba(0, 217, 255, 0.25);
      --lime: #CCFF00;
      --lime-dark: #A8D900;
      --green: #00CC66;
      --amber: #FFAA00;
      --red: #FF4444;
      --red-soft: #FF6B6B;
      --white: #FFFFFF;
      --white-dim: rgba(255, 255, 255, 0.5);
      --white-faint: rgba(255, 255, 255, 0.08);
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body { 
      font-family: 'DM Sans', system-ui, -apple-system, sans-serif;
      background: linear-gradient(180deg, var(--midnight) 0%, var(--deep-teal) 100%);
      min-height: 100vh;
      color: var(--white);
    }
    
    .container { max-width: 480px; margin: 0 auto; padding: 20px; }
    
    /* Header */
    .header { 
      display: flex; align-items: center; gap: 12px; 
      padding: 20px; border-bottom: 1px solid var(--cyan-dim);
      background: rgba(10, 22, 40, 0.95);
      position: sticky; top: 0; z-index: 100;
    }
    .logo { 
      width: 44px; height: 44px; border-radius: 12px;
      background: linear-gradient(135deg, var(--cyan), #00B4CC);
      display: flex; align-items: center; justify-content: center;
      font-size: 22px;
    }
    .header h1 { font-size: 22px; font-weight: 700; }
    .header p { font-size: 11px; color: var(--cyan); letter-spacing: 1px; }
    
    /* Cards */
    .card {
      background: var(--white-faint);
      border-radius: 20px;
      padding: 24px;
      border: 1px solid var(--cyan-dim);
      margin-bottom: 16px;
    }
    
    /* Buttons */
    .btn-primary {
      width: 100%; padding: 18px;
      background: linear-gradient(135deg, var(--lime), var(--lime-dark));
      color: var(--midnight); border: none; border-radius: 14px;
      font-size: 17px; font-weight: 700; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 10px;
      transition: transform 0.2s, opacity 0.2s;
    }
    .btn-primary:hover:not(:disabled) { opacity: 0.9; transform: translateY(-1px); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .btn-secondary {
      width: 100%; padding: 16px;
      background: transparent; color: var(--cyan);
      border: 2px solid var(--cyan); border-radius: 12px;
      font-size: 16px; font-weight: 700; cursor: pointer;
      transition: background 0.2s;
    }
    .btn-secondary:hover { background: rgba(0, 217, 255, 0.1); }
    
    .btn-small {
      padding: 8px 12px;
      background: var(--white-faint);
      border: 1px solid var(--cyan-dim);
      border-radius: 8px; color: var(--white);
      font-size: 12px; cursor: pointer;
      transition: background 0.2s;
    }
    .btn-small:hover { background: rgba(255, 255, 255, 0.12); }
    
    /* Input */
    .input-row { display: flex; gap: 12px; margin-bottom: 16px; }
    .input-row input {
      flex: 1; padding: 16px;
      background: var(--white-faint);
      border: 1px solid var(--cyan-dim);
      border-radius: 12px; color: var(--white);
      font-size: 16px; outline: none;
      font-family: 'JetBrains Mono', monospace;
    }
    .input-row input:focus { border-color: var(--cyan); }
    .input-row input::placeholder { color: var(--white-dim); }
    .input-row button {
      padding: 16px 24px;
      background: var(--cyan); color: var(--midnight);
      border: none; border-radius: 12px;
      font-size: 16px; font-weight: 700; cursor: pointer;
      transition: opacity 0.2s;
    }
    .input-row button:hover:not(:disabled) { opacity: 0.9; }
    .input-row button:disabled { background: rgba(0, 217, 255, 0.3); cursor: not-allowed; }
    
    /* Divider */
    .divider {
      display: flex; align-items: center; gap: 16px;
      margin: 20px 0; color: rgba(255, 255, 255, 0.4);
      font-size: 12px; text-transform: uppercase;
    }
    .divider::before, .divider::after {
      content: ''; flex: 1; height: 1px;
      background: rgba(255, 255, 255, 0.15);
    }
    
    /* Test barcodes */
    .test-codes {
      background: rgba(0, 217, 255, 0.08);
      border-radius: 12px; padding: 16px;
    }
    .test-codes p { font-size: 12px; color: var(--cyan); margin-bottom: 10px; font-weight: 600; }
    .test-codes .buttons { display: flex; flex-wrap: wrap; gap: 8px; }
    
    /* Loading */
    .loading { text-align: center; padding: 40px; }
    .spinner {
      width: 50px; height: 50px;
      border: 3px solid rgba(0, 217, 255, 0.2);
      border-top-color: var(--cyan);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Product display */
    .product-image {
      height: 200px; background: var(--white);
      display: flex; align-items: center; justify-content: center;
      border-radius: 16px 16px 0 0; margin: -24px -24px 20px;
      overflow: hidden;
    }
    .product-image img { max-height: 100%; max-width: 100%; object-fit: contain; }
    .brand { font-size: 12px; color: var(--cyan); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
    .product-name { font-size: 20px; font-weight: 700; margin-bottom: 10px; line-height: 1.3; }
    .product-meta { font-size: 13px; color: var(--white-dim); }
    
    /* Source badge */
    .source-badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 4px 10px; border-radius: 20px;
      font-size: 11px; font-weight: 600;
      margin-top: 12px;
    }
    .source-badge.airtable { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
    .source-badge.external { background: rgba(0, 204, 102, 0.2); color: var(--green); }
    .source-badge.new { background: rgba(255, 170, 0, 0.2); color: var(--amber); }
    
    /* Score */
    .score-section h3 { 
      font-size: 12px; color: var(--white-dim); 
      text-transform: uppercase; margin-bottom: 20px; 
      letter-spacing: 0.5px;
    }
    .score-display { display: flex; align-items: center; gap: 24px; margin-bottom: 24px; }
    .score-circle {
      width: 90px; height: 90px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      position: relative;
    }
    .score-inner {
      width: 72px; height: 72px; border-radius: 50%;
      background: var(--midnight);
      display: flex; align-items: center; justify-content: center;
      font-size: 28px; font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
    }
    .score-label { font-size: 22px; font-weight: 700; margin-bottom: 4px; }
    .score-count { font-size: 14px; color: var(--white-dim); }
    
    /* Domains */
    .domains { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .domain {
      padding: 12px; border-radius: 10px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .domain-name { font-size: 13px; text-transform: uppercase; color: rgba(255, 255, 255, 0.7); }
    .domain-status { font-size: 11px; font-weight: 700; }
    .domain.normal { background: rgba(0, 204, 102, 0.1); }
    .domain.normal .domain-status { color: var(--green); }
    .domain.moderate { background: rgba(255, 170, 0, 0.1); }
    .domain.moderate .domain-status { color: var(--amber); }
    .domain.elevated { background: rgba(255, 68, 68, 0.1); }
    .domain.elevated .domain-status { color: var(--red-soft); }
    
    /* Concerns */
    .concerns {
      background: rgba(255, 170, 0, 0.08);
      border-radius: 10px; padding: 14px;
      margin-bottom: 16px;
    }
    .concerns p:first-child { font-size: 12px; color: var(--amber); font-weight: 600; margin-bottom: 8px; }
    .concerns p:last-child { font-size: 12px; color: rgba(255, 255, 255, 0.7); line-height: 1.5; }
    
    /* Ingredients */
    .ingredients { margin-bottom: 16px; }
    .ingredients h4 { font-size: 12px; color: var(--white-dim); text-transform: uppercase; margin-bottom: 12px; }
    .ingredients p { font-size: 13px; color: rgba(255, 255, 255, 0.7); line-height: 1.7; }
    
    /* Not found */
    .not-found { text-align: center; padding: 20px 0; }
    .not-found-icon {
      width: 72px; height: 72px; border-radius: 50%;
      background: rgba(255, 170, 0, 0.15);
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto 20px; font-size: 32px;
    }
    .not-found h3 { font-size: 20px; margin-bottom: 8px; }
    .not-found p { font-size: 15px; color: var(--white-dim); margin-bottom: 24px; }
    
    /* Add product form */
    .add-form { margin-top: 20px; }
    .add-form h4 { font-size: 14px; color: var(--cyan); margin-bottom: 12px; }
    .form-group { margin-bottom: 12px; }
    .form-group label { 
      display: block; font-size: 12px; color: var(--white-dim); 
      margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%; padding: 12px;
      background: var(--white-faint);
      border: 1px solid var(--cyan-dim);
      border-radius: 8px; color: var(--white);
      font-size: 14px; outline: none;
      font-family: 'DM Sans', sans-serif;
    }
    .form-group textarea { min-height: 100px; resize: vertical; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
      border-color: var(--cyan); 
    }
    
    /* Camera */
    .camera-container { position: relative; border-radius: 20px; overflow: hidden; background: #000; }
    .camera-container video { width: 100%; display: block; }
    .camera-overlay {
      position: absolute; inset: 0;
      display: flex; align-items: center; justify-content: center;
    }
    .scan-frame {
      width: 75%; height: 25%;
      border: 3px solid var(--cyan);
      border-radius: 12px;
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6);
    }
    .camera-hint {
      position: absolute; bottom: 80px;
      left: 0; right: 0; text-align: center;
      color: var(--cyan); font-size: 14px;
    }
    .camera-cancel {
      position: absolute; bottom: 20px;
      left: 50%; transform: translateX(-50%);
      padding: 14px 40px;
      background: rgba(255, 68, 68, 0.9);
      color: var(--white); border: none; border-radius: 10px;
      font-size: 15px; font-weight: 600; cursor: pointer;
    }
    
    /* Status messages */
    .status-msg {
      padding: 12px 16px; border-radius: 10px; margin-bottom: 16px;
      font-size: 14px; display: flex; align-items: center; gap: 10px;
    }
    .status-msg.success { background: rgba(0, 204, 102, 0.15); color: var(--green); }
    .status-msg.error { background: rgba(255, 68, 68, 0.15); color: var(--red-soft); }
    .status-msg.info { background: rgba(0, 217, 255, 0.15); color: var(--cyan); }
    
    .hidden { display: none !important; }
    
    footer { 
      text-align: center; padding: 40px 0; 
      color: rgba(255, 255, 255, 0.25); font-size: 12px; 
    }
    footer a { color: var(--cyan); text-decoration: none; }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="container" style="display:flex;align-items:center;gap:12px;padding:0;">
      <div class="logo">üî¨</div>
      <div>
        <h1>ToxEcology</h1>
        <p>PRODUCT SCANNER</p>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Input Section -->
    <div id="inputSection" class="card">
      <button class="btn-primary" onclick="startCamera()" id="scanBtn">
        <span style="font-size:24px">üì∑</span> Scan Barcode
      </button>
      
      <div class="divider">or enter manually</div>
      
      <div class="input-row">
        <input type="text" id="barcodeInput" inputmode="numeric" placeholder="Enter barcode number">
        <button onclick="lookupBarcode()" id="lookupBtn">Look Up</button>
      </div>
      
      <div class="test-codes">
        <p>üìã Test barcodes:</p>
        <div class="buttons">
          <button class="btn-small" onclick="setBarcode('3017624010701')">Nutella</button>
          <button class="btn-small" onclick="setBarcode('5000159407236')">Coca-Cola</button>
          <button class="btn-small" onclick="setBarcode('3600523735099')">Garnier</button>
          <button class="btn-small" onclick="setBarcode('0016000275287')">Cheerios</button>
        </div>
      </div>
    </div>

    <!-- Camera Section -->
    <div id="cameraSection" class="camera-container hidden">
      <video id="video" autoplay playsinline muted></video>
      <div class="camera-overlay">
        <div class="scan-frame"></div>
      </div>
      <p class="camera-hint">üì∑ Point at barcode - scanning automatically</p>
      <button class="camera-cancel" onclick="stopCamera()">Cancel</button>
    </div>

    <!-- Loading Section -->
    <div id="loadingSection" class="card hidden">
      <div class="loading">
        <div class="spinner"></div>
        <p id="loadingText" style="color:var(--cyan)">Looking up product...</p>
      </div>
    </div>

    <!-- Result Section -->
    <div id="resultSection" class="hidden">
      <!-- Product Card -->
      <div class="card" id="productCard">
        <div class="product-image" id="productImageContainer">
          <img id="productImage" src="" alt="">
        </div>
        <p class="brand" id="productBrand"></p>
        <h2 class="product-name" id="productName"></h2>
        <p class="product-meta" id="productMeta"></p>
        <div id="sourceBadge"></div>
      </div>

      <!-- Score Card -->
      <div class="card score-section">
        <h3>ToxEcology Hazard Score</h3>
        <div class="score-display">
          <div class="score-circle" id="scoreCircle">
            <div class="score-inner" id="scoreValue">--</div>
          </div>
          <div>
            <p class="score-label" id="scoreLabel">Unknown</p>
            <p class="score-count" id="scoreCount">0 ingredients</p>
          </div>
        </div>
        <div class="domains" id="domainsContainer"></div>
        <div class="concerns hidden" id="concernsContainer">
          <p>‚ö†Ô∏è Ingredients of Concern:</p>
          <p id="concernsList"></p>
        </div>
      </div>

      <!-- Ingredients -->
      <div class="card ingredients" id="ingredientsCard">
        <h4>Ingredients</h4>
        <p id="ingredientsList"></p>
      </div>

      <button class="btn-secondary" onclick="reset()">Scan Another Product</button>
    </div>

    <!-- Not Found Section -->
    <div id="notFoundSection" class="card hidden">
      <div class="not-found">
        <div class="not-found-icon">üîç</div>
        <h3>Product Not Found</h3>
        <p id="notFoundBarcode">Barcode: </p>
      </div>
      
      <!-- Add Product Form -->
      <div class="add-form" id="addProductForm">
        <h4>‚ûï Add This Product</h4>
        <p style="font-size:13px;color:var(--white-dim);margin-bottom:16px;">
          Help build our database! Add this product's info below.
        </p>
        
        <div class="form-group">
          <label>Product Name *</label>
          <input type="text" id="newProductName" placeholder="e.g., Dove Body Wash">
        </div>
        
        <div class="form-group">
          <label>Brand *</label>
          <input type="text" id="newProductBrand" placeholder="e.g., Dove">
        </div>
        
        <div class="form-group">
          <label>Category *</label>
          <select id="newProductCategory">
            <option value="">Select category...</option>
            <option value="Food">Food</option>
            <option value="Personal Care">Personal Care</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Sub-Category</label>
          <select id="newProductSubCategory">
            <option value="">Select sub-category...</option>
            <!-- Populated by JavaScript based on category -->
          </select>
        </div>
        
        <div class="form-group">
          <label>Ingredients (from label)</label>
          <textarea id="newProductIngredients" placeholder="Copy ingredients from the product label..."></textarea>
        </div>
        
        <div id="addProductStatus"></div>
        
        <button class="btn-primary" onclick="submitNewProduct()" id="submitProductBtn" style="margin-bottom:12px;">
          <span>üì§</span> Submit Product
        </button>
      </div>
      
      <button class="btn-secondary" onclick="reset()">Try Another Barcode</button>
    </div>

    <footer>
      <p>ToxEcology Beta v2.0</p>
      <p style="margin-top:8px;">Data from <a href="#">your Airtable</a> + Open Food/Beauty Facts</p>
    </footer>
  </div>

  <script>
    // =============================================================================
    // STATE
    // =============================================================================
    let scanning = false;
    let currentBarcode = '';
    let currentProductData = null;

    // Sub-category options by category
    const SUB_CATEGORIES = {
      'Food': [
        'Breakfast Cereal', 'Snacks', 'Bread & Bakery', 'Dairy', 'Condiments',
        'Pasta', 'Rice & Grains', 'Soup', 'Meat', 'Seafood', 'Beverages',
        'Candy & Sweets', 'Baby Food', 'Frozen Vegetables', 'Frozen Entrees', 'Food - Other'
      ],
      'Personal Care': [
        'Shampoo', 'Conditioner', 'Body Wash', 'Body Lotion', 'Deodorant',
        'Sunscreen', 'Oral Care', 'Eye Makeup', 'Lip Makeup', 'Face Makeup',
        'Nail Products', 'Hair Styling', 'Hair Color', 'Baby Care', 'Personal Care - Other'
      ]
    };

    // Concerning ingredients for client-side scoring (backup)
    const CONCERNING = {
      high: ['bht','bha','dmdm hydantoin','formaldehyde','triclosan','oxybenzone','parabens','methylparaben','propylparaben','phthalate','pfas','pfoa','pfos'],
      medium: ['sodium laureth sulfate','sodium lauryl sulfate','fragrance','parfum','artificial color','fd&c','propylene glycol','mineral oil']
    };

    // =============================================================================
    // DOM HELPERS
    // =============================================================================
    const $ = id => document.getElementById(id);

    function showSection(id) {
      ['inputSection', 'cameraSection', 'loadingSection', 'resultSection', 'notFoundSection'].forEach(s => {
        $(s).classList.add('hidden');
      });
      $(id).classList.remove('hidden');
    }

    function setBarcode(code) {
      $('barcodeInput').value = code;
      lookupBarcode();
    }

    function reset() {
      $('barcodeInput').value = '';
      currentBarcode = '';
      currentProductData = null;
      $('addProductStatus').innerHTML = '';
      showSection('inputSection');
    }

    // =============================================================================
    // CAMERA - Using ZXing Library for reliable scanning
    // =============================================================================
    let codeReader = null;
    
    async function startCamera() {
      try {
        // Initialize ZXing reader
        codeReader = new ZXing.BrowserMultiFormatReader();
        
        showSection('cameraSection');
        scanning = true;
        
        // Start continuous scanning
        codeReader.decodeFromVideoDevice(null, 'video', (result, error) => {
          if (result && scanning) {
            const barcode = result.getText();
            console.log('Scanned barcode:', barcode);
            stopCamera();
            $('barcodeInput').value = barcode;
            lookupBarcode();
          }
          // Ignore errors - they happen every frame when no barcode is visible
        });
        
      } catch (e) {
        console.error('Camera error:', e);
        alert('Camera access denied or not available. Please use manual entry.');
        showSection('inputSection');
      }
    }

    function stopCamera() {
      scanning = false;
      if (codeReader) {
        codeReader.reset();
        codeReader = null;
      }
      showSection('inputSection');
    }

    // =============================================================================
    // CATEGORY/SUBCATEGORY HANDLING
    // =============================================================================
    $('newProductCategory').addEventListener('change', function() {
      const category = this.value;
      const subSelect = $('newProductSubCategory');
      subSelect.innerHTML = '<option value="">Select sub-category...</option>';
      
      if (category && SUB_CATEGORIES[category]) {
        SUB_CATEGORIES[category].forEach(sub => {
          const opt = document.createElement('option');
          opt.value = sub;
          opt.textContent = sub;
          subSelect.appendChild(opt);
        });
      }
    });

    // =============================================================================
    // HAZARD SCORING (Client-side fallback)
    // =============================================================================
    function calculateClientScore(ingredients) {
      if (!ingredients) return { score: null, count: 0, concerns: [], domains: {} };
      
      const lower = ingredients.toLowerCase();
      const list = lower.split(/[,;]/).map(i => i.trim()).filter(i => i);
      let score = 20;
      const found = [];

      CONCERNING.high.forEach(ing => { if (lower.includes(ing)) { score += 15; found.push(ing); }});
      CONCERNING.medium.forEach(ing => { if (lower.includes(ing)) { score += 8; found.push(ing); }});
      score += Math.min(20, list.length * 0.5);

      return {
        score: Math.min(100, Math.round(score)),
        count: list.length,
        concerns: found,
        domains: {
          pfas: found.some(i => ['pfas','pfoa','pfos'].includes(i)) ? 'elevated' : 'normal',
          parabens: found.some(i => i.includes('paraben')) ? 'elevated' : 'normal',
          phthalates: found.some(i => i.includes('phthalate')) ? 'elevated' : 'normal',
          vocs: found.some(i => ['fragrance','parfum'].includes(i)) ? 'moderate' : 'normal',
          metals: 'normal',
          pesticides: 'normal',
          mycotoxins: 'normal',
          plastics: 'normal'
        }
      };
    }

    function getScoreColor(s) {
      if (s === null) return '#6B7280';
      if (s <= 30) return '#00CC66';
      if (s <= 55) return '#FFAA00';
      return '#FF4444';
    }

    function getScoreLabel(s) {
      if (s === null) return 'Unknown';
      if (s <= 30) return 'Low Risk';
      if (s <= 55) return 'Moderate';
      return 'Elevated';
    }

    // =============================================================================
    // API CALLS
    // =============================================================================
    
    // Lookup product via Netlify Function ‚Üí Airtable
    async function lookupAirtable(barcode) {
      try {
        const res = await fetch(`/.netlify/functions/lookup-product?barcode=${barcode}`);
        if (!res.ok) return null;
        const data = await res.json();
        if (data.found) {
          return {
            source: 'ToxEcology Database',
            sourceType: 'airtable',
            ...data.product
          };
        }
        return null;
      } catch (e) {
        console.error('Airtable lookup error:', e);
        return null;
      }
    }

    // Lookup product via Open Food Facts
    async function lookupOpenFoodFacts(barcode) {
      try {
        const res = await fetch(`https://world.openfoodfacts.org/api/v2/product/${barcode}?fields=product_name,brands,ingredients_text,categories,image_url`);
        if (!res.ok) return null;
        const data = await res.json();
        if (data.status !== 1 || !data.product) return null;
        return {
          source: 'Open Food Facts',
          sourceType: 'external',
          name: data.product.product_name || 'Unknown Product',
          brand: data.product.brands || 'Unknown Brand',
          ingredients: data.product.ingredients_text || null,
          category: 'Food',
          imageUrl: data.product.image_url || null,
          barcode
        };
      } catch (e) { console.error('OFF:', e); return null; }
    }

    // Lookup product via Open Beauty Facts
    async function lookupOpenBeautyFacts(barcode) {
      try {
        const res = await fetch(`https://world.openbeautyfacts.org/api/v2/product/${barcode}?fields=product_name,brands,ingredients_text,categories,image_url`);
        if (!res.ok) return null;
        const data = await res.json();
        if (data.status !== 1 || !data.product) return null;
        return {
          source: 'Open Beauty Facts',
          sourceType: 'external',
          name: data.product.product_name || 'Unknown Product',
          brand: data.product.brands || 'Unknown Brand',
          ingredients: data.product.ingredients_text || null,
          category: 'Personal Care',
          imageUrl: data.product.image_url || null,
          barcode
        };
      } catch (e) { console.error('OBF:', e); return null; }
    }

    // Match ingredients against Airtable ingredient_hazards
    async function matchIngredients(ingredients) {
      if (!ingredients) return null;
      try {
        const res = await fetch('/.netlify/functions/lookup-ingredients', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ingredients })
        });
        if (!res.ok) return null;
        return await res.json();
      } catch (e) {
        console.error('Ingredient matching error:', e);
        return null;
      }
    }

    // Submit new product to Airtable
    async function addProductToAirtable(product) {
      try {
        const res = await fetch('/.netlify/functions/add-product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(product)
        });
        return await res.json();
      } catch (e) {
        console.error('Add product error:', e);
        return { success: false, error: e.message };
      }
    }

    // =============================================================================
    // MAIN LOOKUP FLOW
    // =============================================================================
    async function lookupBarcode() {
      const barcode = $('barcodeInput').value.replace(/\D/g, '');
      if (!barcode || barcode.length < 8) {
        alert('Please enter a valid barcode (8-14 digits)');
        return;
      }

      currentBarcode = barcode;
      showSection('loadingSection');
      
      // Step 1: Check Airtable first
      $('loadingText').textContent = 'Checking ToxEcology database...';
      let product = await lookupAirtable(barcode);
      
      // Step 2: Try Open Food Facts
      if (!product) {
        $('loadingText').textContent = 'Searching food database...';
        product = await lookupOpenFoodFacts(barcode);
      }
      
      // Step 3: Try Open Beauty Facts
      if (!product) {
        $('loadingText').textContent = 'Searching personal care database...';
        product = await lookupOpenBeautyFacts(barcode);
      }

      if (product) {
        currentProductData = product;
        
        // If from external source, match ingredients and AUTO-SAVE to Airtable
        if (product.sourceType === 'external') {
          
          // Match ingredients against our database
          if (product.ingredients) {
            $('loadingText').textContent = 'Analyzing ingredients...';
            const ingredientMatch = await matchIngredients(product.ingredients);
            if (ingredientMatch && ingredientMatch.hazardScore !== undefined) {
              product.hazardScore = ingredientMatch.hazardScore;
              product.domains = ingredientMatch.domains;
              product.matchedCount = ingredientMatch.matchedCount;
              product.concerns = ingredientMatch.concerns;
            }
          }
          
          // AUTO-SAVE to Airtable
          $('loadingText').textContent = 'Saving to ToxEcology database...';
          const saveResult = await addProductToAirtable({
            barcode: product.barcode,
            name: product.name,
            brand: product.brand,
            category: product.category,
            sub_category: product.sub_category || '',
            ingredients: product.ingredients || ''
          });
          
          if (saveResult.success) {
            console.log('Auto-saved product:', saveResult.product_id);
            product.autoSaved = true;
            product.savedProductId = saveResult.product_id;
          } else {
            console.log('Auto-save skipped or failed:', saveResult.error);
            // Don't block display if save fails (might be duplicate)
            if (saveResult.error && saveResult.error.includes('already exists')) {
              product.alreadyInDatabase = true;
            }
          }
        }
        
        displayProduct(product);
      } else {
        $('notFoundBarcode').textContent = `Barcode: ${barcode}`;
        showSection('notFoundSection');
      }
    }

    // =============================================================================
    // DISPLAY PRODUCT
    // =============================================================================
    function displayProduct(product) {
      // Product info
      if (product.imageUrl) {
        $('productImage').src = product.imageUrl;
        $('productImage').onerror = () => $('productImageContainer').style.display = 'none';
        $('productImageContainer').style.display = 'flex';
      } else {
        $('productImageContainer').style.display = 'none';
      }
      
      $('productBrand').textContent = product.brand || 'Unknown Brand';
      $('productName').textContent = product.name || 'Unknown Product';
      $('productMeta').textContent = `${product.category || 'Unknown'} ‚Ä¢ ${product.sub_category || ''}`;
      
      // Source badge
      let badgeClass = 'external';
      let badgeText = product.source;
      if (product.sourceType === 'airtable') {
        badgeClass = 'airtable';
        badgeText = '‚úì ToxEcology Database';
      } else if (product.autoSaved) {
        badgeClass = 'airtable';
        badgeText = '‚úì Added to ToxEcology Database';
      } else if (product.alreadyInDatabase) {
        badgeClass = 'airtable';
        badgeText = '‚úì Already in Database';
      }
      $('sourceBadge').innerHTML = `<span class="source-badge ${badgeClass}">${badgeText}</span>`;

      // Score - use Airtable score if available, otherwise client-side calculation
      let hazard;
      if (product.hazardScore !== undefined) {
        hazard = {
          score: product.hazardScore,
          count: product.matchedCount || product.ingredientCount || 0,
          concerns: product.concerns || [],
          domains: product.domains || {}
        };
      } else {
        hazard = calculateClientScore(product.ingredients);
      }
      
      const color = getScoreColor(hazard.score);
      
      $('scoreCircle').style.background = hazard.score !== null 
        ? `conic-gradient(${color} ${hazard.score * 3.6}deg, rgba(255,255,255,0.08) 0deg)`
        : 'rgba(255,255,255,0.08)';
      $('scoreValue').textContent = hazard.score !== null ? hazard.score : '?';
      $('scoreValue').style.color = color;
      $('scoreLabel').textContent = getScoreLabel(hazard.score);
      $('scoreLabel').style.color = color;
      $('scoreCount').textContent = `${hazard.count} ingredients analyzed`;

      // Domains
      const domainLabels = {
        pfas: 'PFAS', parabens: 'Parabens', phthalates: 'Phthalates',
        vocs: 'VOCs', metals: 'Metals', pesticides: 'Pesticides',
        mycotoxins: 'Mycotoxins', plastics: 'Plastics'
      };
      
      const domainsHtml = Object.entries(hazard.domains || {}).map(([name, status]) => `
        <div class="domain ${status}">
          <span class="domain-name">${domainLabels[name] || name}</span>
          <span class="domain-status">${(status || 'normal').toUpperCase()}</span>
        </div>
      `).join('');
      $('domainsContainer').innerHTML = domainsHtml;

      // Concerns
      if (hazard.concerns && hazard.concerns.length > 0) {
        $('concernsList').textContent = hazard.concerns.join(', ');
        $('concernsContainer').classList.remove('hidden');
      } else {
        $('concernsContainer').classList.add('hidden');
      }

      // Ingredients
      if (product.ingredients) {
        $('ingredientsList').textContent = product.ingredients;
        $('ingredientsCard').classList.remove('hidden');
      } else {
        $('ingredientsCard').classList.add('hidden');
      }

      showSection('resultSection');
    }

    // =============================================================================
    // SUBMIT NEW PRODUCT
    // =============================================================================
    async function submitNewProduct() {
      const name = $('newProductName').value.trim();
      const brand = $('newProductBrand').value.trim();
      const category = $('newProductCategory').value;
      const subCategory = $('newProductSubCategory').value;
      const ingredients = $('newProductIngredients').value.trim();
      
      // Validation
      if (!name || !brand || !category) {
        $('addProductStatus').innerHTML = '<div class="status-msg error">‚ö†Ô∏è Please fill in all required fields</div>';
        return;
      }
      
      $('submitProductBtn').disabled = true;
      $('submitProductBtn').innerHTML = '<span class="spinner" style="width:20px;height:20px;border-width:2px;margin:0;"></span> Submitting...';
      
      const product = {
        barcode: currentBarcode,
        name,
        brand,
        category,
        sub_category: subCategory,
        ingredients
      };
      
      const result = await addProductToAirtable(product);
      
      if (result.success) {
        $('addProductStatus').innerHTML = `
          <div class="status-msg success">
            ‚úÖ Product added successfully! ID: ${result.product_id}
          </div>
        `;
        
        // Auto-lookup the newly added product after a moment
        setTimeout(() => {
          lookupBarcode();
        }, 1500);
      } else {
        $('addProductStatus').innerHTML = `
          <div class="status-msg error">
            ‚ùå ${result.error || 'Failed to add product'}
          </div>
        `;
        $('submitProductBtn').disabled = false;
        $('submitProductBtn').innerHTML = '<span>üì§</span> Submit Product';
      }
    }

    // =============================================================================
    // INIT
    // =============================================================================
    $('barcodeInput').addEventListener('keydown', e => {
      if (e.key === 'Enter') lookupBarcode();
    });
  </script>
</body>
</html>
