<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToxEcology Lab Parser</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß¨</text></svg>">
    <style>
        :root {
            --midnight-navy: #0A1628;
            --glacier-cyan: #00D9FF;
            --electric-lime: #CCFF00;
            --dark-slate: #1a2d4a;
            --muted-text: #8899aa;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, var(--midnight-navy) 0%, var(--dark-slate) 100%);
            min-height: 100vh;
            color: #fff;
        }
        
        /* Header */
        .header {
            background: rgba(10, 22, 40, 0.95);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--glacier-cyan);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .logo-text {
            font-size: 1.25rem;
            font-weight: 700;
            color: #fff;
        }
        
        .logo-text span {
            color: var(--glacier-cyan);
        }
        
        .header-badge {
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid rgba(0, 217, 255, 0.3);
            color: var(--glacier-cyan);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        /* Main Content */
        .main {
            max-width: 900px;
            margin: 0 auto;
            padding: 48px 24px;
        }
        
        .page-title {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .page-title h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .page-title p {
            color: var(--muted-text);
            font-size: 1rem;
        }
        
        /* Card */
        .card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        
        .card-header .step {
            width: 28px;
            height: 28px;
            background: var(--glacier-cyan);
            color: var(--midnight-navy);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
        }
        
        .card-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        /* Form Elements */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 600px) {
            .form-row { grid-template-columns: 1fr; }
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group:last-child {
            margin-bottom: 0;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.9);
        }
        
        input[type="text"], select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 10px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: var(--glacier-cyan);
            box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.1);
        }
        
        input[type="text"]::placeholder { color: #556677; }
        
        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%238899aa' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
        }
        
        select option {
            background: var(--midnight-navy);
            color: #fff;
        }
        
        /* File Drop */
        .file-drop {
            border: 2px dashed rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 48px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(0,0,0,0.2);
        }
        
        .file-drop:hover {
            border-color: var(--glacier-cyan);
            background: rgba(0, 217, 255, 0.05);
        }
        
        .file-drop.dragover {
            border-color: var(--glacier-cyan);
            background: rgba(0, 217, 255, 0.1);
            transform: scale(1.01);
        }
        
        .file-drop.has-file {
            border-color: var(--electric-lime);
            background: rgba(204, 255, 0, 0.05);
        }
        
        .file-drop-icon {
            width: 56px;
            height: 56px;
            margin: 0 auto 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .file-drop-text {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .file-drop-hint {
            color: var(--muted-text);
            font-size: 0.85rem;
        }
        
        .file-name {
            color: var(--electric-lime);
            font-weight: 600;
            margin-top: 12px;
            word-break: break-all;
        }
        
        /* Button */
        .btn {
            width: 100%;
            padding: 16px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--glacier-cyan);
            color: var(--midnight-navy);
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #00c4e6;
            transform: translateY(-1px);
            box-shadow: 0 8px 24px rgba(0, 217, 255, 0.25);
        }
        
        .btn-primary:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.08);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .btn-secondary:hover {
            background: rgba(255,255,255,0.12);
        }
        
        /* Status */
        .status {
            display: none;
            text-align: center;
            padding: 32px;
        }
        
        .status.show { display: block; }
        
        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid rgba(0, 217, 255, 0.2);
            border-top-color: var(--glacier-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .status-text {
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .timer {
            color: var(--muted-text);
            font-size: 0.9rem;
        }
        
        /* Results */
        .results {
            display: none;
        }
        
        .results.show { display: block; }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .results-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .results-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-sm {
            padding: 8px 14px;
            font-size: 0.85rem;
            border-radius: 8px;
        }
        
        .btn-lime {
            background: var(--electric-lime);
            color: var(--midnight-navy);
        }
        
        .btn-lime:hover {
            background: #b8e600;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--electric-lime);
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--muted-text);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Table */
        .table-container {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.08);
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        th {
            background: rgba(0, 217, 255, 0.1);
            color: var(--glacier-cyan);
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
        }
        
        td {
            font-size: 0.9rem;
        }
        
        tr:hover td {
            background: rgba(255,255,255,0.02);
        }
        
        /* Download Buttons */
        .download-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        /* Error */
        .error {
            background: rgba(255, 100, 100, 0.1);
            border: 1px solid rgba(255, 100, 100, 0.3);
            color: #ff6b6b;
            padding: 16px;
            border-radius: 10px;
            margin-top: 16px;
            display: none;
        }
        
        .error.show { display: block; }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 32px;
            color: var(--muted-text);
            font-size: 0.85rem;
        }
        
        .footer a {
            color: var(--glacier-cyan);
            text-decoration: none;
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="/" class="logo">
            <div class="logo-icon">üß¨</div>
            <div class="logo-text">Tox<span>Ecology</span></div>
        </a>
        <div class="header-badge">Lab Parser v1.0</div>
    </header>

    <main class="main">
        <div class="page-title">
            <h1>Lab Report Parser</h1>
            <p>Extract biomarker data from Vibrant Wellness & Tribal Diagnostics PDFs</p>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="step">1</div>
                <h2>Report Details</h2>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="panelType">Panel Type</label>
                    <select id="panelType">
                        <optgroup label="Vibrant Wellness">
                            <option value="total-tox">Total Tox Burden</option>
                            <option value="ox-stress">Oxidative Stress</option>
                            <option value="methylation">Methylation</option>
                        </optgroup>
                        <optgroup label="Tribal Diagnostics">
                            <option value="tribal-serum">Serum Wellness Panel</option>
                        </optgroup>
                    </select>
                </div>
                <div class="form-group">
                    <label for="patientId">Patient ID <span style="color: var(--muted-text); font-weight: normal;">(optional)</span></label>
                    <input type="text" id="patientId" placeholder="e.g., CL-002">
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="step">2</div>
                <h2>Upload PDF</h2>
            </div>
            
            <div class="form-group">
                <div class="file-drop" id="fileDrop">
                    <div class="file-drop-icon">üìÑ</div>
                    <div class="file-drop-text">Drop PDF here or click to browse</div>
                    <div class="file-drop-hint" id="fileDropHint">Vibrant Wellness Total Tox Burden (.pdf) ‚Ä¢ ~108 markers</div>
                    <div class="file-name" id="fileName"></div>
                </div>
                <input type="file" id="fileInput" accept=".pdf" style="display:none">
            </div>
        </div>

        <button class="btn btn-primary" id="parseBtn" disabled>
            <span>Parse Lab Report</span>
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
            </svg>
        </button>

        <div class="status" id="status">
            <div class="spinner"></div>
            <div class="status-text">Processing with AI...</div>
            <div class="timer" id="timer">0s</div>
        </div>

        <div class="error" id="error"></div>

        <div class="results card" id="results">
            <div class="results-header">
                <h3>Extraction Results</h3>
                <div class="results-actions">
                    <button class="btn btn-sm btn-lime" id="copyBtn">üìã Copy</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="markerCount">0</div>
                    <div class="stat-label">Markers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="reportId">-</div>
                    <div class="stat-label">Report ID</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="parseTime">0s</div>
                    <div class="stat-label">Parse Time</div>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr id="tableHeaders">
                            <th>Marker</th>
                            <th>Value</th>
                            <th>Result ID</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody"></tbody>
                </table>
            </div>

            <div class="download-row">
                <button class="btn btn-secondary" id="downloadCsvBtn">‚¨áÔ∏è Download CSV</button>
                <button class="btn btn-secondary" id="downloadJsonBtn">‚¨áÔ∏è Download JSON</button>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>¬© 2025 ToxEcology ‚Ä¢ <a href="https://toxecology.com">toxecology.com</a></p>
    </footer>

    <script>
        // API Endpoints (relative for same-origin, absolute for cross-origin)
        const ENDPOINTS = {
            'total-tox': 'https://onnv6jddscpnmymbhpfzrafzfu0ktaud.lambda-url.us-east-2.on.aws/',
            'ox-stress': '/.netlify/functions/parse-vibrant',
            'methylation': '/.netlify/functions/parse-vibrant',
            'tribal-serum': '/.netlify/functions/parse-tribal'
        };

        // Panel configurations
        const PANEL_CONFIG = {
            'total-tox': { lab: 'Vibrant', name: 'Total Tox Burden', markers: 108 },
            'ox-stress': { lab: 'Vibrant', name: 'Oxidative Stress', panelType: 'OX', markers: 14 },
            'methylation': { lab: 'Vibrant', name: 'Methylation', panelType: 'METH', markers: 14 },
            'tribal-serum': { lab: 'Tribal', name: 'Serum Wellness', markers: '~50' }
        };

        let selectedFile = null;
        let resultsData = null;
        let timerInterval = null;

        // Elements
        const panelType = document.getElementById('panelType');
        const fileDrop = document.getElementById('fileDrop');
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const fileDropHint = document.getElementById('fileDropHint');
        const parseBtn = document.getElementById('parseBtn');
        const status = document.getElementById('status');
        const error = document.getElementById('error');
        const results = document.getElementById('results');
        const timer = document.getElementById('timer');

        // Panel hint text
        const PANEL_HINTS = {
            'total-tox': 'Vibrant Wellness Total Tox Burden (.pdf) ‚Ä¢ ~108 markers',
            'ox-stress': 'Vibrant Wellness Oxidative Stress (.pdf) ‚Ä¢ ~14 markers',
            'methylation': 'Vibrant Wellness Methylation (.pdf) ‚Ä¢ ~14 markers',
            'tribal-serum': 'Tribal Diagnostics Serum Panel (.pdf) ‚Ä¢ ~50 markers'
        };

        // Update hint on panel change
        panelType.addEventListener('change', () => {
            fileDropHint.textContent = PANEL_HINTS[panelType.value] || 'Lab report (.pdf)';
        });

        // File handling
        fileDrop.addEventListener('click', () => fileInput.click());
        fileDrop.addEventListener('dragover', (e) => { e.preventDefault(); fileDrop.classList.add('dragover'); });
        fileDrop.addEventListener('dragleave', () => fileDrop.classList.remove('dragover'));
        fileDrop.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDrop.classList.remove('dragover');
            if (e.dataTransfer.files[0]?.type === 'application/pdf') {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) handleFile(e.target.files[0]);
        });

        function handleFile(file) {
            selectedFile = file;
            fileName.textContent = file.name;
            fileDrop.classList.add('has-file');
            parseBtn.disabled = false;
        }

        // Parse
        parseBtn.addEventListener('click', async () => {
            if (!selectedFile) return;
            
            error.classList.remove('show');
            results.classList.remove('show');
            status.classList.add('show');
            parseBtn.disabled = true;

            let seconds = 0;
            timer.textContent = '0s';
            timerInterval = setInterval(() => { 
                seconds++; 
                timer.textContent = seconds + 's'; 
            }, 1000);

            try {
                const base64 = await fileToBase64(selectedFile);
                const patientId = document.getElementById('patientId').value.trim();
                const panel = panelType.value;
                const endpoint = ENDPOINTS[panel];
                const config = PANEL_CONFIG[panel];

                // Build payload based on lab type
                let payload;
                if (config.lab === 'Tribal') {
                    payload = { pdfBase64: base64, patientId: patientId };
                } else if (panel === 'total-tox') {
                    payload = { pdf: base64, patient_id: patientId };
                } else {
                    payload = { pdf: base64, patient_id: patientId, panel_type: config.panelType };
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                clearInterval(timerInterval);
                status.classList.remove('show');
                parseBtn.disabled = false;

                if (!response.ok || data.error) {
                    throw new Error(data.error || 'Parse failed');
                }

                // Normalize response
                data.biomarker_count = data.biomarker_count || data.count || data.results?.length || 0;

                resultsData = data;
                resultsData._panelConfig = config;
                displayResults(data, seconds);

            } catch (err) {
                clearInterval(timerInterval);
                status.classList.remove('show');
                parseBtn.disabled = false;
                error.textContent = 'Error: ' + err.message;
                error.classList.add('show');
            }
        });

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function displayResults(data, seconds) {
            document.getElementById('markerCount').textContent = data.biomarker_count || data.results?.length || 0;
            document.getElementById('reportId').textContent = data.report_id || '-';
            document.getElementById('parseTime').textContent = seconds + 's';

            const tbody = document.getElementById('resultsBody');
            const headers = document.getElementById('tableHeaders');
            tbody.innerHTML = '';
            
            const items = data.results || [];
            const isTribal = data._panelConfig?.lab === 'Tribal';
            
            // Update headers based on lab type
            if (isTribal) {
                headers.innerHTML = '<th>Marker</th><th>Value</th><th>Units</th><th>Ref Range</th><th>Flag</th>';
            } else {
                headers.innerHTML = '<th>Marker</th><th>Value</th><th>Result ID</th>';
            }
            
            items.forEach(r => {
                const tr = document.createElement('tr');
                if (isTribal) {
                    const refRange = [r.ref_low, r.ref_high].filter(v => v != null && v !== '').join(' - ') || '‚Äî';
                    const flagClass = r.flag === 'H' ? 'color: #ff6b6b;' : r.flag === 'L' ? 'color: #4dabf7;' : '';
                    tr.innerHTML = `
                        <td>${r.marker_name_original || r.marker_id_inbox || '-'}</td>
                        <td>${r.value}</td>
                        <td>${r.units || '-'}</td>
                        <td>${refRange}</td>
                        <td style="${flagClass} font-weight: 600;">${r.flag || '-'}</td>
                    `;
                } else {
                    tr.innerHTML = `<td>${r.marker_id_inbox || r.marker_id || '-'}</td><td>${r.value}</td><td>${r.result_id}</td>`;
                }
                tbody.appendChild(tr);
            });
            
            results.classList.add('show');
        }

        function generateCSV(data) {
            const items = data.results || [];
            const isTribal = data._panelConfig?.lab === 'Tribal';
            
            if (isTribal) {
                const headers = ['result_id', 'report_id', 'patient_id', 'marker_id_inbox', 'marker_name_original', 'value', 'units', 'ref_low', 'ref_high', 'flag', 'category'];
                const rows = items.map(r => [
                    r.result_id, r.report_id, r.patient_id || '',
                    r.marker_id_inbox, `"${(r.marker_name_original || '').replace(/"/g, '""')}"`,
                    r.value, r.units || '', r.ref_low || '', r.ref_high || '',
                    r.flag || '', r.category || ''
                ].join(','));
                return [headers.join(','), ...rows].join('\n');
            } else {
                const headers = ['result_id', 'report_id', 'patient_id', 'marker_id_inbox', 'value', 'marker_type'];
                const rows = items.map(r => [
                    r.result_id, r.report_id, r.patient_id, 
                    r.marker_id_inbox || r.marker_id, r.value, r.marker_type
                ].join(','));
                return [headers.join(','), ...rows].join('\n');
            }
        }

        // Copy
        document.getElementById('copyBtn').addEventListener('click', () => {
            if (!resultsData) return;
            navigator.clipboard.writeText(generateCSV(resultsData));
            document.getElementById('copyBtn').textContent = '‚úì Copied!';
            setTimeout(() => { document.getElementById('copyBtn').textContent = 'üìã Copy'; }, 2000);
        });

        // Download CSV
        document.getElementById('downloadCsvBtn').addEventListener('click', () => {
            if (!resultsData) return;
            const csv = generateCSV(resultsData);
            downloadFile(csv, (resultsData.report_id || 'results') + '.csv', 'text/csv');
        });

        // Download JSON
        document.getElementById('downloadJsonBtn').addEventListener('click', () => {
            if (!resultsData) return;
            const json = JSON.stringify(resultsData, null, 2);
            downloadFile(json, (resultsData.report_id || 'results') + '.json', 'application/json');
        });

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
