<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vibrant PDF Parser - Total Tox (100% Extraction)</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0A1628 0%, #1a2744 100%);
      min-height: 100vh;
      color: #fff;
      padding: 20px;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { text-align: center; margin-bottom: 10px; color: #00D9FF; }
    .subtitle { text-align: center; color: #888; margin-bottom: 30px; }
    .subtitle span { color: #CCFF00; }
    
    .input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .input-group label { color: #00D9FF; display: block; margin-bottom: 5px; font-size: 14px; }
    .input-group input {
      width: 100%;
      padding: 12px;
      background: #1a2744;
      border: 1px solid #00D9FF33;
      border-radius: 8px;
      color: #fff;
      font-size: 16px;
    }
    
    .upload-area {
      border: 2px dashed #00D9FF;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      margin-bottom: 20px;
      cursor: pointer;
      transition: all 0.3s;
      background: #0A162866;
    }
    .upload-area:hover { background: #00D9FF11; border-color: #CCFF00; }
    .upload-area.has-file { border-color: #CCFF00; background: #CCFF0011; }
    .upload-area input { display: none; }
    
    .btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #00D9FF, #00B4CC);
      border: none;
      border-radius: 8px;
      color: #0A1628;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 20px;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 20px #00D9FF44; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .results-header h2 { color: #00D9FF; }
    .btn-group { display: flex; gap: 10px; }
    .btn-small {
      padding: 10px 20px;
      background: #1a2744;
      border: 1px solid #00D9FF;
      border-radius: 6px;
      color: #00D9FF;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-small:hover { background: #00D9FF22; }
    .btn-small.primary { background: #CCFF00; color: #0A1628; border-color: #CCFF00; }
    
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
    .stat {
      background: #1a2744;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-value { font-size: 32px; font-weight: bold; color: #00D9FF; }
    .stat-label { color: #888; font-size: 12px; margin-top: 5px; }
    .stat-value.panel { color: #CCFF00; font-size: 24px; }
    
    table { width: 100%; border-collapse: collapse; background: #1a2744; border-radius: 8px; overflow: hidden; }
    th { background: #0A1628; color: #00D9FF; padding: 12px; text-align: left; }
    td { padding: 12px; border-bottom: 1px solid #0A162866; }
    tr:hover td { background: #00D9FF11; }
    .type-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 12px;
      background: #00D9FF33;
      color: #00D9FF;
    }
    
    .status { text-align: center; padding: 20px; color: #00D9FF; }
    .status.error { color: #ff6b6b; }
    
    .warning {
      background: #CCFF0022;
      border: 1px solid #CCFF00;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      color: #CCFF00;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ Vibrant PDF Parser - Total Tox</h1>
    <p class="subtitle">Uses <span>Sonnet</span> for 100% marker extraction (requires 60s+ timeout)</p>
    
    <div class="warning">
      ‚ö†Ô∏è This parser requires a hosting platform with 60+ second timeout. 
      Netlify Pro only allows 26 seconds. Deploy to AWS Lambda, Vercel Pro, or run locally.
    </div>
    
    <div class="input-group">
      <div>
        <label>Patient ID</label>
        <input type="text" id="patientId" placeholder="e.g., CL-002">
      </div>
      <div>
        <label>Report ID (auto-detected)</label>
        <input type="text" id="reportId" placeholder="Will be extracted from PDF" readonly>
      </div>
    </div>
    
    <label>Vibrant PDF</label>
    <div class="upload-area" id="uploadArea">
      <input type="file" id="pdfInput" accept=".pdf">
      <div id="uploadLabel">üìÑ Click or drag PDF here</div>
    </div>
    
    <button class="btn" id="extractBtn" disabled>üß¨ Extract Lab Results</button>
    
    <div id="status" class="status" style="display:none;"></div>
    
    <div id="results" style="display:none;">
      <div class="results-header">
        <h2>Extracted Results</h2>
        <div class="btn-group">
          <button class="btn-small" onclick="copyTSV()">üìã Copy TSV</button>
          <button class="btn-small primary" onclick="downloadCSV()">üì• Download CSV</button>
        </div>
      </div>
      
      <div class="stats">
        <div class="stat">
          <div class="stat-value" id="totalCount">0</div>
          <div class="stat-label">Total Results</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="biomarkerCount">0</div>
          <div class="stat-label">Biomarkers</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="snpCount">0</div>
          <div class="stat-label">SNPs</div>
        </div>
        <div class="stat">
          <div class="stat-value panel" id="panelType">-</div>
          <div class="stat-label">Panel Type</div>
        </div>
      </div>
      
      <table>
        <thead>
          <tr>
            <th>Result ID</th>
            <th>Marker ID</th>
            <th>Value</th>
            <th>Type</th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    let currentResults = [];
    let currentReportId = '';
    let currentPanelType = '';
    
    const uploadArea = document.getElementById('uploadArea');
    const pdfInput = document.getElementById('pdfInput');
    const uploadLabel = document.getElementById('uploadLabel');
    const extractBtn = document.getElementById('extractBtn');
    const statusDiv = document.getElementById('status');
    const resultsDiv = document.getElementById('results');
    
    // File upload handling
    uploadArea.addEventListener('click', () => pdfInput.click());
    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.style.borderColor = '#CCFF00'; });
    uploadArea.addEventListener('dragleave', () => { uploadArea.style.borderColor = '#00D9FF'; });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      if (e.dataTransfer.files[0]) {
        pdfInput.files = e.dataTransfer.files;
        handleFileSelect();
      }
    });
    pdfInput.addEventListener('change', handleFileSelect);
    
    function handleFileSelect() {
      if (pdfInput.files[0]) {
        uploadLabel.innerHTML = `‚úÖ ${pdfInput.files[0].name}`;
        uploadArea.classList.add('has-file');
        extractBtn.disabled = false;
      }
    }
    
    // Extract button
    extractBtn.addEventListener('click', async () => {
      const file = pdfInput.files[0];
      if (!file) return;
      
      extractBtn.disabled = true;
      statusDiv.style.display = 'block';
      statusDiv.className = 'status';
      statusDiv.textContent = 'üî¨ Claude Sonnet is reading the PDF... (this may take 60+ seconds)';
      resultsDiv.style.display = 'none';
      
      try {
        const base64 = await fileToBase64(file);
        const patientId = document.getElementById('patientId').value;
        
        // CHANGE THIS URL to your deployed function
        const response = await fetch('/.netlify/functions/parse-vibrant-tox-sonnet', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pdf: base64, patient_id: patientId })
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        
        displayResults(data);
        
      } catch (error) {
        statusDiv.className = 'status error';
        statusDiv.textContent = `‚ùå Error: ${error.message}`;
      }
      
      extractBtn.disabled = false;
    });
    
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    
    function displayResults(data) {
      currentResults = data.results || [];
      currentReportId = data.report_id || '';
      currentPanelType = data.panel_type || 'TOX';
      
      document.getElementById('reportId').value = currentReportId;
      document.getElementById('totalCount').textContent = currentResults.length;
      document.getElementById('biomarkerCount').textContent = data.biomarker_count || currentResults.length;
      document.getElementById('snpCount').textContent = data.snp_count || 0;
      document.getElementById('panelType').textContent = currentPanelType;
      
      const tbody = document.getElementById('resultsBody');
      tbody.innerHTML = currentResults.map(r => `
        <tr>
          <td>${r.result_id}</td>
          <td>${r.marker_id_inbox}</td>
          <td>${r.value}</td>
          <td><span class="type-badge">${r.marker_type}</span></td>
        </tr>
      `).join('');
      
      statusDiv.style.display = 'none';
      resultsDiv.style.display = 'block';
    }
    
    function copyTSV() {
      const headers = 'result_id\treport_id\tpatient_id\tmarker_id_inbox\tvalue';
      const rows = currentResults.map(r => 
        `${r.result_id}\t${r.report_id}\t${r.patient_id}\t${r.marker_id_inbox}\t${r.value}`
      ).join('\n');
      navigator.clipboard.writeText(headers + '\n' + rows);
      alert('TSV copied to clipboard!');
    }
    
    function downloadCSV() {
      const headers = 'result_id,report_id,patient_id,marker_id_inbox,value';
      const rows = currentResults.map(r => 
        `"${r.result_id}","${r.report_id}","${r.patient_id}","${r.marker_id_inbox}",${r.value}`
      ).join('\n');
      
      const blob = new Blob([headers + '\n' + rows], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `vibrant_tox_results_${currentReportId}.csv`;
      a.click();
    }
  </script>
</body>
</html>
